<!DOCTYPE html>
<html>
<head>
	<title></title>
</head>
<body>
<script type="text/javascript">

	function getDataURLImage(source, hflip) {
		return new Promise(resolve => {
			const image = new Image();

			// Async
			image.addEventListener('load', function () {			
				const canvas = document.createElement("canvas");
				canvas.height = this.height;
				canvas.width = this.width;
				const ctx = canvas.getContext("2d");
				if ((hflip) && (hflip == true)) { 
					ctx.translate(this.width, 0);
					ctx.scale(-1, 1);
				}
				ctx.drawImage(image, 0, 0);
				resolve(canvas.toDataURL());
			});
			image.src = source;
		});
	}

	function loadedImage(source) {
		return new Promise(resolve => {
			const image = new Image();
			// Async
			image.addEventListener('load', function () {
				resolve(image);
			});
			image.src = source;
		});
	}


	// getDataURLImage("./img/player/sprite_1.png").then(dataurl => {
	// 	loadedImage(dataurl).then(image => {
	// 		console.log('Image: ' + image.src);	
	// 	});
	// });

	// getDataURLImage("./img/player/sprite_1.png", true).then(dataurl => {
	// 	loadedImage(dataurl).then(image => {
	// 		console.log('Image: ' + image.src);	
	// 	});
	// });

	class Player {
		height = 256;
		width = 256;

		constructor() {
			this.loaded = false;

			// this.sprites = ["./img/player/sprite_1.png", "./img/player/sprite_2.png"]
			this.sprites = ["./img/truck/truck.png"]
			this.stdframes = [];
			this.leftframes = [];
			this.frameindex = 0;
			this.framearray = this.stdframes;
		}

		onload(cb) {
			const self = this;

			for (var i = 0; i < self.sprites.length; i++) {
				getDataURLImage(self.sprites[i]).then(dataurl => {
					loadedImage(dataurl).then(image => {
						console.debug('Image: ' + self.sprites[i] + ' -> ' + image.src);
						self.stdframes.push(image);
					});
				});

				getDataURLImage(self.sprites[i], true).then(dataurl => {
					loadedImage(dataurl).then(image => {
						console.debug('Flipped image: ' + self.sprites[i] + ' -> ' + image.src);
						self.leftframes.push(image);
					});
				});
			}

		}

		getframe() {
			if ((this.frameindex + 1) >= this.framearray.length) {
				this.frameindex = 0;
			}
			else {
				this.frameindex += 1;
			}
			console.log("Frameindex: " + this.frameindex);
			return this.framearray[this.frameindex];
		}

		left() {
			this.framearray = this.leftframes;
		}

		right() {
			this.framearray = this.stdframes;
		}

		up() {

		}

		down() {

		}
	}

	class Level {
		constructor () {
			this.canvas = document.createElement("canvas");
			this.canvas.id = "GameCanvas"

			document.body.appendChild(this.canvas);

			this.player = new Player();
			this.playerpos = [0, 0];

			this.canvas.height = this.player.height * 10;
			this.canvas.width = this.player.width * 10;

			this.ctx = this.canvas.getContext("2d");
		}

		onload(cb) {			
			document.onkeydown = this.keydown.bind(this);
			// document.addEventListener('keydown', this.keydown);

			var self = this;
			this.player.onload(function () {
				var img = self.player.getframe();
				self.ctx.drawImage(img, self.playerpos[0], self.playerpos[1]);
			});

			cb();
		}

		keydown(e) {
			e = e || window.event;
			var keyCode = e.keyCode;
			if (keyCode >= 37 && keyCode <= 40) {
				e.preventDefault();
				this.ctx.clearRect(this.playerpos[0], this.playerpos[1], this.playerpos[0] + this.player.width, this.playerpos[1] + this.player.height);

				var width = this.player.width;
				var height = this.player.height;

				if (keyCode == 38) {
					// up
					var newpos = [this.playerpos[0], this.playerpos[1] - this.player.height];
					if (this.boundcheck(newpos)) {
						this.playerpos = newpos;
					}
					this.player.up();
				}
				else if (keyCode == 40) {
				    // down
				    var newpos = [this.playerpos[0], (this.playerpos[1] + this.player.height)];
				    if (this.boundcheck(newpos)) {
				    	this.playerpos = newpos;
				    }
				    this.player.down();
				}
				else if (keyCode == 37) {
					// left
				   	var newpos = [(this.playerpos[0] - this.player.width), this.playerpos[1]];
				    if (this.boundcheck(newpos)) {
				    	this.playerpos = newpos;
				    }
				    this.player.left();
				}
				else if (keyCode == 39) {
					// right
				   	var newpos = [(this.playerpos[0] + this.player.width), this.playerpos[1]];
				    if (this.boundcheck(newpos)) {
				    	this.playerpos = newpos;
				    }
				    this.player.right();
				}
				this.ctx.drawImage(this.player.getframe(), this.playerpos[0], this.playerpos[1]);
			    return false;
			}
		}

		boundcheck(pos) {			
			if ((pos[0] >= 0) && ((pos[0] + this.player.width) <= this.canvas.width) &&
				(pos[1] >= 0) && ((pos[1] + this.player.height) <= this.canvas.height))
			{
				console.debug("boundcheck: " + pos + " - OK");
				return true;
			}
			else 
			{
				console.debug("boundcheck: " + pos + " - No way");
				return false;
			}
		}
	}

	var level = new Level();
	level.onload(function () {});
</script>
</body>
</html>
